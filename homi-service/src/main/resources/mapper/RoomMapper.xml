<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.homi.model.mapper.RoomMapper">
    <resultMap id="RoomDetailMap" type="com.homi.domain.dto.room.RoomItemDTO">
        <id property="roomId" column="room_id"/>
        <result property="houseId" column="house_id"/>
        <result property="roomNumber" column="room_number"/>
        <result property="houseCode" column="house_code"/>
        <result property="houseName" column="house_name"/>
        <result property="modeRefId" column="mode_ref_id"/>
        <result property="leaseMode" column="lease_mode"/>
        <result property="price" column="price"/>
        <result property="salesmanId" column="salesman_id"/>
        <result property="salesmanName" column="nickname"/>
        <result property="salesmanPhone" column="phone"/>
        <result property="area" column="area"/>
        <result property="direction" column="direction"/>
        <result property="roomStatus" column="room_status"/>
        <result property="locked" column="locked"/>
        <result property="closed" column="closed"/>
        <result property="leased" column="leased"/>
        <!-- 添加floor字段 -->
        <result property="floor" column="floor"/>

        <!-- 如果需要包含房型信息等集合 -->
        <collection property="houseLayout" ofType="com.homi.domain.dto.room.HouseLayoutDTO">
            <id property="id" column="layout_id"/>
            <result property="layoutName" column="layout_name"/>
            <result property="livingRoom" column="living_room"/>
            <result property="bedroom" column="bedroom"/>
            <result property="bathroom" column="bathroom"/>
            <result property="kitchen" column="kitchen"/>
        </collection>
    </resultMap>

    <select id="getPage" resultMap="RoomDetailMap">
        SELECT r.id AS room_id,
        r.house_id AS house_id,
        h.house_code,
        h.house_name AS house_name,
        h.lease_mode,
        h.mode_ref_id,
        r.room_number,
        r.floor,
        r.price,
        r.room_status,
        r.locked,
        r.closed,
        r.leased,
        r.area,
        r.direction,
        h.salesman_id,
        u.nickname,
        u.phone,
        hl.id AS layout_id,
        hl.layout_name AS layout_name,
        hl.bedroom,
        hl.living_room,
        hl.bathroom,
        hl.kitchen
        FROM room r
        LEFT JOIN house h ON r.house_id = h.id
        LEFT JOIN house_layout hl ON h.house_layout_id = hl.id
        LEFT JOIN user u ON u.id = h.salesman_id
        where r.deleted = 0
        <include refid="roomListQuery">
        </include>

        order by r.id desc
    </select>

    <select id="getStatusTotal" resultType="com.homi.domain.dto.room.RoomTotalItemDTO">
        SELECT room_status, count(room_status) AS total
        FROM room r
        LEFT JOIN house h ON r.house_id = h.id
        LEFT JOIN user u ON u.id = h.salesman_id
        where r.deleted = 0
        <include refid="roomListQuery">
        </include>
        group by room_status
    </select>

    <sql id="roomListQuery">
        <if test="query.keywords != null and query.keywords != ''">
            and r.keywords like concat('%', #{query.keywords,jdbcType=VARCHAR}, '%')
        </if>

        <if test="query.roomStatus != null">
            and r.room_status = #{query.roomStatus,jdbcType=INTEGER}
        </if>

        <if test="query.modeRefId != null">
            and h.mode_ref_id = #{query.modeRefId,jdbcType=BIGINT}
        </if>

        <if test="query.leaseMode != null">
            and h.lease_mode = #{query.leaseMode,jdbcType=INTEGER}
        </if>
    </sql>
</mapper>
